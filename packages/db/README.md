# Database Package

Shared database package providing the **Drizzle ORM** client and schema definitions for the entire monorepo.

## Technologies

- **Database Engine**: PostgreSQL (via `node-postgres` Pool)
- **ORM**: [Drizzle ORM](https://orm.drizzle.team/)
- **Migration Tool**: [Drizzle Kit](https://orm.drizzle.team/kit-docs/overview)
- **Validation**: [Drizzle Zod](https://orm.drizzle.team/docs/zod)

## Setup

Ensure you have a `.env` file with the following:

- `DB_URL`: PostgreSQL connection string.
- `DB_USER`: Database user.
- `DB_PASSWORD`: Database password.
- `DB_HOST`: Database host.
- `DB_PORT`: Database port.
- `DB_NAME`: Database name.
- `DB_SSL_MODE`: Database SSL mode (e.g., `disable`).

## Scripts

Execute these scripts from the root using `pnpm --filter=@repo/db <script>` or directly in this folder.

```bash
pnpm db:generate    # Generate Drizzle migration files
pnpm db:migrate     # Run pending migrations
pnpm db:push        # Push schema directly to DB (dev shortcut)
pnpm db:studio      # Open Drizzle Studio GUI
pnpm build          # Compile to dist/
```

## Architecture

- `src/index.ts`: Exports `db` client, `initDB()`/`disconnectDB()`, and re-exports all models/types.
- `src/models/`: Drizzle table definitions.
  - `auth/schema.ts`: Auto-generated by Better Auth CLI (`pnpm auth:generate` from monorepo root) — **do not edit manually**.
  - `schema.ts`: App-specific model definitions.
  - `types.ts`: Zod types via `drizzle-zod`.
- `drizzle/`: Generated SQL migration files.

## Package Exports

This package provides multiple entry points via `package.json`:

- `@repo/db` — db client + models + types
- `@repo/db/schema` — schema only
- `@repo/db/types` — types only
- `@repo/db/drizzle-orm` — re-exports from drizzle-orm

## Adding a Table

1. Create or edit a file in `src/models/`
2. Export the table from `src/models/schema.ts`
3. **Local dev**: Run `pnpm db:generate` then `pnpm db:migrate`
4. **Docker**: `db:generate` runs automatically during `make build`; `db:migrate` runs automatically on container startup

## Usage

This package is used by:

- `apps/api`: To perform database operations.
- `apps/app`: Indirectly via API procedures.
