# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### Local Development

```bash
pnpm install          # Install all dependencies
pnpm dev              # Start all services (frontend :33460, backend :33450)
pnpm build            # Build all packages
pnpm lint             # Lint all packages

# Database (runs against packages/db)
pnpm db:generate      # Generate Drizzle migrations
pnpm db:migrate       # Run migrations
pnpm db:push          # Push schema changes directly (dev only)
pnpm auth:generate    # Regenerate Better Auth schema into packages/db

# Run a single app
pnpm --filter api dev
pnpm --filter app dev
pnpm --filter @repo/db db:studio   # Open Drizzle Studio

# Skills (for AI agents)
pnpm skills:symlink:all   # Symlink skills to .claude, .cursor, and .agent directories
```

### Docker Commands (Production Only)

```bash
# Setup and Deployment
make env-setup        # Copy .env.docker to .env
make validate         # Pre-flight check
make build            # Build production images
make up               # Start containers in detached mode

# Monitoring
make logs-api         # Watch migrations and API logs
make logs             # View all logs
make stats            # View container resource usage

# Maintenance
make migrate          # Run migrations manually
make migrate-gen      # Generate new migrations
make shell-api        # Access API container terminal
make down             # Stop services
make clean-all        # Full cleanup (removes volumes)
```

**Note:** Use `pnpm dev` for local development. Docker is for production only.

## Architecture

Monorepo using **pnpm workspaces** + **Turborepo**.

### `apps/api` — Hono backend

- Entry: `src/index.ts` → initializes DB, registers plugins (CORS, ORPC, OpenAPI/Scalar, Auth), serves on Hono
- **ORPC procedures** in `src/router/middleware.ts`: `publicProcedure`, `authProcedure`, `adminProcedure` — `authProcedure` uses `auth.api.getSession()` to inject typed `user`/`session` into context
- Routes defined in `src/router/routes/` and aggregated in `src/router/index.ts` which exports `AppRouter` type
- **Auth** is handled natively by Better Auth — mounted as a Hono plugin at `/auth/*`, not through oRPC. Auth types (`User`, `Session`) exported from `src/config/auth.ts`. Supports **Bearer tokens** for API access (via `better-auth/plugins/bearer`) alongside cookie-based sessions.
- Plugins in `src/plugins/` register Hono middleware (CORS, ORPC handler, OpenAPI spec, Scalar docs, Better Auth)
- Config in `src/config/` (env, auth, nodemailer) — auth config includes database hooks for post-signup logic
- API base path set via `env.API_V1_PREFIX`

### `apps/app` — React frontend

- Vite + React 19 + SWC
- **TanStack Router** with file-based routing in `src/routes/`
  - `_auth.tsx` layout: requires session, redirects to login if unauthenticated
  - `_notauth.tsx` layout: redirects to `/` if already authenticated
- **ORPC client** in `src/lib/orpc.ts` — imports `AppRouter` type from `api/orpc` for end-to-end type safety, uses TanStack Query integration
- **Auth client** in `src/lib/auth.ts` — uses Better Auth's `createAuthClient` with plugins (emailOTP, organization, admin). Auth flows (login, signup, password reset) use `authClient.*` methods directly, NOT oRPC
- **Session state** via `useSession()` from Better Auth (replaces Jotai atoms for auth state). Other client state via Jotai
- UI: Tailwind CSS 4, Base UI primitives, shadcn components in `src/components/ui/`
- Path alias: `@/` → `src/`

### `packages/db` — Shared database

- Drizzle ORM + PostgreSQL (`node-postgres`)
- Models in `src/models/` — auth schema auto-generated by Better Auth CLI
- Exports: `@repo/db` (db client + models), `@repo/db/schema`, `@repo/db/types`, `@repo/db/drizzle-orm`
- Env: `.env` in this package for DB connection (also `.env` in `apps/api`)

### `packages/tsconfig`, `packages/eslint-config` — Shared configs

## Key Patterns

- **Adding an API route**: Create file in `apps/api/src/router/routes/`, use `publicProcedure`/`authProcedure`/`adminProcedure` from `middleware.ts`, add to router in `router/index.ts`
- **Adding a page**: Create file in `apps/app/src/routes/` following TanStack Router file conventions. Put under `_auth/` for protected pages, `_notauth/` for guest-only pages
- **DB schema changes**: Edit models in `packages/db/src/models/`, run `pnpm db:generate` then `pnpm db:migrate`
- **Type flow**: Backend route types flow to frontend via `AppRouter` type export → ORPC client → TanStack Query hooks
- **Zod 4** is used for validation across both frontend and backend

## Docker Deployment

The project is containerized for production deployment:

- **Multi-stage Dockerfiles** in `apps/api/Dockerfile` and `apps/app/Dockerfile` (3 stages: deps, build, production)
- **Docker Compose** orchestration with PostgreSQL service
- **Automatic database migrations** on API container startup
- **Production mode** with optimized Alpine-based images
- **Health checks** on all services for reliability
- **Helper scripts** in `docker/scripts/` for common operations

**Health Endpoints:**

- API: `GET /api/v1/health` - Returns status, timestamp, uptime, environment
- Frontend: `GET /health` - Returns healthy status

**Documentation:**

- [DOCKER.md](./DOCKER.md) - **Primary Docker Guide**
- [docker/README.md](./docker/README.md) - Advanced configuration (technical)

**Note:** For local development, use `pnpm dev` directly. Docker is for production only.
